name: Build Static PHP Cli

on:
    workflow_dispatch:

permissions:
    contents: write
    packages: write
    id-token: write

jobs:
    build-and-push:
        strategy:
            matrix:
                variants:
                    - architecture: amd64
                      runner: ubuntu-24.04
                      dockerfile: ./static/Dockerfile.static.cli
                      version: 8.4
                    - architecture: arm64
                      runner: ubuntu-24.04-arm
                      dockerfile: ./static/Dockerfile.static.cli
                      version: 8.4

        runs-on: ${{ matrix.variants.runner }}
        name: "Build ${{ matrix.variants.version }} ${{ matrix.variants.architecture }}"
        steps:
            - name: Checkout Source Code
              id: checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Login to Docker Hub
              id: login
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Static Binary Inside Docker Image
              run: |
                   docker buildx build -t php-static-cli:${{ matrix.variants.version }}-${{ matrix.variants.architecture }} -f ./static/Dockerfile.static.cli .

            - name: Extract the PHP binary from the image
              run: |
                # Create a temporary container from the built image
                CONTAINER_ID=$(docker create php-static-cli:${{ matrix.variants.version }}-${{ matrix.variants.architecture }})

                # Copy the file from the container to the runner's filesystem
                docker cp ${CONTAINER_ID}:/workspace/buildroot/bin/php ./php-${{ matrix.variants.version }}-${{ matrix.variants.architecture }}

                # Clean up the temporary container
                docker rm ${CONTAINER_ID}

            - name: Upload the binary as an artifact
              uses: actions/upload-artifact@v4
              with:
                  name: php-static-cli-${{ matrix.variants.version }}-${{ matrix.variants.architecture }}
                  path: ./php-${{ matrix.variants.version }}-${{ matrix.variants.architecture }}
                  retention-days: 2


